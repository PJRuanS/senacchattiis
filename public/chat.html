<!DOCTYPE html>
<html lang="pt-br"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Senac MG - Chat da Turma</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>

    <style>
        /* Reset e Base */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { 
            background: #f5f5f5; 
            color: #333; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh;
        }

        /* Cores Senac unificadas com os outros arquivos */
        :root {
            --senac-blue: #0055a5;
            --senac-dark-blue: #003c73;
            --senac-red: #cc0000;
            --senac-yellow: #ffcd00;
            --senac-main-dark: #1A4099; /* Cor principal de fundos no chat */
        }

        #chat-container {
            width: 100%;
            max-width: 800px;
            height: 90vh;
            max-height: 900px;
            display: none; /* Escondido até o usuário ser validado */
            flex-direction: column;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            background: white;
        }

        /* Header do Chat */
        #chat-header {
            background-color: var(--senac-main-dark);
            color: white;
            padding: 15px 20px;
            text-align: center;
            border-bottom: 2px solid var(--senac-yellow);
        }

        #chat-header h1 {
            font-size: 1.4em;
            margin-bottom: 5px;
        }

        #current-user-display {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* Área de Mensagens */
        #messages {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: #fcfcfc;
        }

        .message {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 15px;
            line-height: 1.4;
            word-wrap: break-word;
            box-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
            font-size: 0.95em;
        }

        .my-message {
            background-color: #d1e7ff; /* Azul claro do Senac */
            align-self: flex-end;
            border-bottom-right-radius: 0;
        }

        .other-message {
            background-color: #f1f0f0; /* Cinza claro */
            align-self: flex-start;
            border-bottom-left-radius: 0;
        }

        .message strong {
            display: block;
            font-weight: bold;
            font-size: 0.8em;
            color: var(--senac-dark-blue);
            margin-bottom: 3px;
        }
        
        .my-message strong {
            color: var(--senac-blue);
        }

        /* Formulário de Envio */
        #message-form {
            display: flex;
            padding: 10px 20px;
            background-color: #fff;
            border-top: 1px solid #ddd;
        }

        #message-input {
            flex-grow: 1;
            padding: 12px 15px;
            border: 1px solid #ccc;
            border-radius: 20px;
            margin-right: 10px;
            font-size: 1em;
            outline: none;
            transition: border-color 0.3s;
        }

        #message-input:focus {
            border-color: var(--senac-yellow);
        }

        #send-button {
            padding: 10px 20px;
            background-color: var(--senac-red);
            color: white;
            border: none;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #send-button:hover {
            background-color: #a30000;
        }
        
        /* Mensagem de Feedback Customizada (Substitui alert) */
        #custom-feedback {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--senac-red);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 1;
            transition: opacity 1s, top 0.3s;
        }
        
        /* ----------------- MEDIA QUERIES PARA RESPONSIVIDADE TOTAL ----------------- */
        @media (max-width: 768px) {
            body {
                /* Remove o padding e a centralização para ocupar a tela inteira */
                padding: 0;
                margin: 0;
            }

            #chat-container {
                width: 100vw; /* Ocupa a largura total da tela */
                height: 100vh; /* Ocupa a altura total da tela */
                max-width: none;
                max-height: none;
                border-radius: 0; /* Remove bordas arredondadas para tela cheia */
                box-shadow: none; /* Remove a sombra */
            }

            /* Header do Chat */
            #chat-header {
                padding: 15px 10px;
            }
            #chat-header h1 {
                font-size: 1.2em; /* Reduz o tamanho da fonte */
            }

            /* Área de Mensagens */
            #messages {
                padding: 10px; /* Reduz o padding */
                gap: 8px;
            }

            .message {
                max-width: 90%; /* Permite que a mensagem ocupe um pouco mais de espaço */
                padding: 8px 10px;
                font-size: 0.9em;
            }

            /* Formulário de Envio */
            #message-form {
                padding: 10px;
            }
            #message-input {
                flex-grow: 1; 
                padding: 10px;
                font-size: 0.95em;
            }
            #send-button {
                padding: 10px 15px; /* Ajusta o padding do botão */
                font-size: 0.95em;
            }
        }
    </style>
</head>
<body>
    <div id="chat-container" style="display: flex;">
        <header id="chat-header">
            <h1>Chat da Turma Senac</h1>
            <p id="current-user-display">Olá, Usuário</p>
        </header>

        <ul id="messages">
            </ul>

        <form id="message-form">
            <input id="message-input" autocomplete="off" placeholder="Digite sua mensagem...">
            <button id="send-button">Enviar</button>
        </form>
    </div>
    
    <div id="custom-feedback" style="display: none;"></div>

    <script>
        // Função para exibir mensagem de feedback customizada
        function showCustomMessage(message, isError = false) {
            const feedback = document.createElement('div');
            feedback.id = 'custom-feedback';
            feedback.textContent = message;
            feedback.style.backgroundColor = isError ? 'var(--senac-red)' : 'var(--senac-main-dark)';
            feedback.style.color = 'white';
            document.body.appendChild(feedback);

            // Temporizador para remover a mensagem
            setTimeout(() => {
                feedback.style.opacity = '0';
                setTimeout(() => feedback.remove(), 1000);
            }, 4000);
        }

        // Variáveis globais
        const chatContainer = document.getElementById('chat-container');
        const messages = document.getElementById('messages');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        let currentUserName = "Usuário Deslogado"; // Valor padrão

        // Conexão com o servidor de Socket.IO
        // ATENÇÃO: A URL base DEVE APONTAR para o seu servidor no Render.
        const API_BASE_URL = 'https://chat-senac-api.onrender.com';
        const socket = io(API_BASE_URL);

        function addMessage(msg) {
            const item = document.createElement('li');
            const isMyMessage = msg.user === currentUserName;
            
            item.classList.add('message');
            item.classList.add(isMyMessage ? 'my-message' : 'other-message');
            
            // Adiciona o nome do usuário se não for a sua mensagem
            const userSpan = document.createElement('strong');
            userSpan.textContent = isMyMessage ? 'Você' : msg.user;
            item.appendChild(userSpan);
            
            // Adiciona o texto da mensagem
            const textNode = document.createTextNode(msg.text);
            item.appendChild(textNode);
            
            messages.appendChild(item);
            
            // Rola para a última mensagem
            messages.scrollTop = messages.scrollHeight;
        }

        messageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const text = messageInput.value.trim();

            if (text === "") return;

            const messageData = { user: currentUserName, text };

            // 1. Envia a mensagem para o servidor
            socket.emit('mensagem', messageData);
            
            // 2. Adiciona a mensagem IMEDIATAMENTE na sua tela (otimista)
            addMessage(messageData); 

            messageInput.value = "";
        });

        // O listener agora apenas adiciona a mensagem, esperando que o servidor
        // envie corretamente para todos os clientes, incluindo o cliente receptor.
        socket.on('mensagem', (msg) => {
            addMessage(msg); 
        });

        function initChat() {
            const storedUser = localStorage.getItem('senacUser');
            const headerUserDisplay = document.getElementById('current-user-display');

            if (!storedUser) {
                // Usando showCustomMessage
                showCustomMessage("Você precisa estar logado para acessar o chat. Redirecionando...", true);
                
                // Redireciona para o login.html
                setTimeout(() => {
                    window.location.href = "login.html";
                }, 2000); 
                return;
            }

            currentUserName = storedUser;
            headerUserDisplay.textContent = `Olá, ${currentUserName}`;
            chatContainer.style.display = "flex";

            // Informa ao servidor que o usuário entrou
            socket.emit("user_join", currentUserName);
        }

        initChat();
    </script>


</body></html>
